<!DOCTYPE html>
<html lang="en">
<html xmls:th="http://www.thymeleaf.org">

</html>

<head th:insert="~{layouts/head}">

</head>

<body>
	<header th:insert="~{layouts/header}"></header>
	<script>
		function actualizarInputFecha() {
			const selectFecha = document.getElementById("fecha");
			const inputFecha = document.getElementById("appointmentDate");
			const fechaSeleccionada = selectFecha.value; // Valor en formato YYYY-MM-DD
			inputFecha.value = fechaSeleccionada;
			obtenerHorarios() // Asigna la fecha seleccionada al input
		}

		function obtenerHorarios() {
			const fechaSeleccionada = document.getElementById("appointmentDate").value; // Fecha en formato yyyy-MM-dd
			const horariosSelect = document.getElementById("appointmentTime");
			const horarioLabel = document.getElementById("appointmentTimeLabel");

			// Limpiar horarios previos y ocultar el select mientras se realiza la búsqueda
			horariosSelect.innerHTML = "";
			horariosSelect.style.display = "none";
			horarioLabel.style.display = "none";

			if (fechaSeleccionada) {
				fetch(`/horarios-disponibles?fecha=${fechaSeleccionada}`)
					.then(response => {
						if (!response.ok) {
							throw new Error(`Error en la respuesta: ${response.status}`);
						}
						return response.json();
					})
					.then(horarios => {
						if (horarios.length > 0) {
							horarios.forEach(horario => {
								const option = document.createElement("option");
								option.value = horario;
								option.textContent = horario;
								horariosSelect.appendChild(option);
							});

							// Mostrar el select y su label si hay horarios disponibles
							horariosSelect.style.display = "block";
							horarioLabel.style.display = "block";
						} else {
							const option = document.createElement("option");
							option.value = "";
							option.textContent = "No hay horarios disponibles";
							horariosSelect.appendChild(option);

							// Mostrar el select con la opción de "No hay horarios disponibles"
							horariosSelect.style.display = "block";
							horarioLabel.style.display = "block";
						}
					})
					.catch(error => {
						console.error("Error al obtener los horarios:", error);
					});
			}
		}

		function setTodayDate(inputId) {
			// Obtiene la fecha de hoy
			const today = new Date();

			// Formatea la fecha en el formato 'YYYY-MM-DD' requerido por los inputs de tipo date
			const formattedDate = today.toISOString().split('T')[0];

			// Busca el input por su ID y establece el valor
			const dateInput = document.getElementById(inputId);
			if (dateInput) {
				dateInput.value = formattedDate;
			} else {
				console.error(`Input con id '${inputId}' no encontrado.`);
			}
		}

		// Llamada a la función con el ID del input
	</script>

	<h1>Seleccionar Turno</h1>
	<form th:action="@{/save/appointment}" method="post" class="col-md-8 offset-md-2">

		<label for="fecha">Fecha:</label>
		<input class="form-select" type="date" id="appointmentDate" name="appointmentDate" onchange="obtenerHorarios()">

		<select class="form-select" id="fecha" name="fecha" onchange="actualizarInputFecha()" multiple>
			<option value="" disabled selected>Seleccione una fecha</option>
			<option th:each="fecha : ${fechasDisponibles}" th:value="${fecha.fechaISO}" th:text="${fecha.fecha}">
		</select>

		<div class="col-sm-10">
			<select class="form-select" name="appointmentType" id="appointmentType">
				<option th:value="'Practica' + ' ' + 'regular'" selected="selected">Practica regular</option>
				<option th:value="'Giro'+ ' ' + 'en' + ' ' +'U'">Redes Sociales</option>
				<option th:value="Conos">Conos</option>
			</select>
		</div>

		<!-- Select de Horarios -->
		<label for="horario" id="appointmentTimeLabel" style="display: none;">Horario:</label>
		<select class="form-select" id="appointmentTime" name="appointmentTime" style="display: none;" multiple>
		</select>

		<label for="appointmentType">Tipo de turno:</label>


		<input id="id" name="id" type="text" th:value="${student != null ? student.id : id}">

		<!-- Botón de Enviar -->
		<button type="submit">Reservar</button>


	</form>

	<script>
		setTodayDate('appointmentDate');

		document.addEventListener("DOMContentLoaded", () => {
			// Al cargar la página, verifica si el campo de fecha tiene un valor
			const inputFecha = document.getElementById("appointmentDate");
			if (inputFecha && inputFecha.value) {
				obtenerHorarios(); // Llama a obtenerHorarios si ya hay una fecha seleccionada
			}
		});
	</script>
</body>

</html>